{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Math Maze - Level 1</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #0e2d14;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        h1 {
            color: #ffd166;
            text-shadow: 2px 2px #2d6a4f;
            margin-bottom: 5px;
        }

        .turn-indicator {
            margin-bottom: 5px;
            font-size: 1.8em;
            color: #b7f397;
            font-weight: bold;
            align-self: flex-start;
            margin-left: 250px;
        }

        /* 🎲 Dice + button area */
        .dice-container {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; /* so moves box can be placed to the right */
        }

        .dice-row {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            align-items: center;
            justify-content: center; /* dice centered under button */
        }

        .dice {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: white;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            box-shadow: 0 0 10px #000;
            transition: transform 0.2s ease;
        }

        /* 📦 Moves-left box – floated to the right (red-squared area) */
        .moves-wrapper {
            position: absolute;
            top: 2px; /* vertical alignment next to dice */
            right: -110px; /* push it to the right of the button/dice stack */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .moves-title {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 4px;
            color: #facc15;
            text-shadow: 1px 1px #000;
        }

        .moves-box {
            width: 80px; /* bigger than dice */
            height: 80px;
            border-radius: 14px;
            background: #0f172a;
            color: #facc15;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2em;
            font-weight: bold;
            box-shadow: 0 0 10px #000;
        }

        .roll-btn {
            background: linear-gradient(145deg,#40916c,#95d5b2);
            border: none;
            color: white;
            font-size: 1.2em;
            padding: 8px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 0 #1b4332;
            transition: transform 0.2s;
        }

            .roll-btn:active {
                transform: translateY(3px);
                box-shadow: 0 2px 0 #1b4332;
            }

        .game-container {
            position: relative;
            width: 90vw;
            height: 85vh;
            background-color: #1b4332;
            border: 4px solid #74c69d;
            border-radius: 15px;
            box-shadow: 0 0 25px #40916c;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        canvas {
            width: 95%;
            height: 90%;
            background: linear-gradient(180deg,#144d28,#0b3316);
            border-radius: 10px;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(145deg,#40916c,#95d5b2);
            color: white;
            border: none;
            font-size: 1.2em;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 0 #1b4332;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 10;
        }

        .legend {
            position: absolute;
            right: 10px;
            top: 10px;
            background: #0f3b23;
            padding: 10px 16px;
            border-radius: 12px;
            border: 3px solid #74c69d;
            box-shadow: 0 0 12px #000;
            color: white;
            width: 190px;
            font-size: 0.9em;
            z-index: 15;
        }

        .legend-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-weight: bold;
            color: #ffd166;
        }

            .legend-header span.icon {
                font-size: 1.1em;
                margin-right: 6px;
            }

            .legend-header span.arrow {
                font-size: 1.1em;
            }

        .legend-body {
            margin-top: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .legend-box {
            width: 22px;
            height: 22px;
            display: inline-block;
            margin-right: 8px;
            border-radius: 4px;
            border: 1px solid #fff3;
        }

        .legend-circle {
            width: 18px;
            height: 18px;
            display: inline-block;
            margin-right: 8px;
            border-radius: 50%;
            border: 1px solid #fff3;
        }

        .legend.collapsed .legend-body {
            display: none;
        }
    </style>
</head>
<body>
    <h1>The Math Maze - Level 1</h1>
    <div class="turn-indicator" id="turnText">Turn: Player 1 🟡</div>

    <div class="dice-container">
        <button class="roll-btn" id="rollButton">🎲 Roll Dice</button>

        
        <div class="dice-row">
            <div class="dice" id="dice1">-</div>
            <div class="dice" id="dice2">-</div>
        </div>

        
        <div class="moves-wrapper">
            <div class="moves-title">Moves Left</div>
            <div class="moves-box" id="movesBox">0</div>
        </div>
    </div>

    <button class="back-btn" onclick="window.location.href='{% url 'options' %}'">← Back</button>

    <div class="game-container">
        <canvas id="mazeCanvas" width="800" height="600"></canvas>
    </div>

    <audio id="bgMusic" src="{% static 'audio/mazemusic.mp3' %}" loop></audio>

    <div class="legend collapsed" id="legend">
        <div class="legend-header" id="legendHeader">
            <span><span class="icon">🗺️</span>Map Key</span>
            <span class="arrow" id="legendArrow">▼</span>
        </div>

        <div class="legend-body" id="legendBody">
            <div class="legend-item">
                <span class="legend-box" style="background:#4ade80;"></span> Start Tile
            </div>
            <div class="legend-item">
                <span class="legend-box" style="background:#0ea5e9;"></span> End Tile
            </div>
            <div class="legend-item">
                <span class="legend-circle" style="background:#fde047;"></span> Player 1
            </div>
            <div class="legend-item">
                <span class="legend-circle" style="background:#38bdf8;"></span> Player 2
            </div>
            <div class="legend-item">
                <span class="legend-circle" style="background:#9d4edd;"></span> AI
            </div>
            <div class="legend-item">
                <span class="legend-box" style="background:#9A3412;"></span> Locked Door
            </div>
            <div class="legend-item">
                <span class="legend-box" style="background:#22C55E;"></span> Unlocked Door
            </div>
            <div class="legend-item">
                <span class="legend-box" style="background:#145214;"></span> Maze Wall
            </div>
            <div class="legend-item">
                <span class="legend-box" style="background:#A7E074;"></span> Path
            </div>
        </div>
    </div>

    <script>
        
        const bgMusic = document.getElementById("bgMusic");

        function startMusic() {
            if (!bgMusic) return;
            bgMusic.volume = 0.4;
            bgMusic.play().catch(() => { });
        }

        const unlockMusic = () => {
            startMusic();
            window.removeEventListener("click", unlockMusic);
            window.removeEventListener("keydown", unlockMusic);
            window.removeEventListener("mousemove", unlockMusic);
        };

        document.addEventListener("DOMContentLoaded", () => {
            window.addEventListener("click", unlockMusic);
            window.addEventListener("keydown", unlockMusic);
            window.addEventListener("mousemove", unlockMusic);
        });

        const canvas = document.getElementById("mazeCanvas"), ctx = canvas.getContext("2d");
        const rows = 15, cols = 20, tileSize = 40;
        const maze = Array(rows).fill().map(() => Array(cols).fill(1));
        let frameCount = 0;

        const legend = document.getElementById("legend");
        const legendHeader = document.getElementById("legendHeader");
        const legendArrow = document.getElementById("legendArrow");

        legendHeader.addEventListener("click", () => {
            legend.classList.toggle("collapsed");
            legendArrow.textContent = legend.classList.contains("collapsed") ? "▼" : "▲";
        });

        const startAtTop = Math.random() < 0.5;
        const startRow = startAtTop ? 1 : rows - 2, endRow = startAtTop ? rows - 2 : 1, startCol = 1, endCol = cols - 2;

        function shuffle(a) {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
        function generateMaze(r, c) {
            maze[r][c] = 0;
            for (const [dr, dc] of shuffle([[0, 2], [0, -2], [2, 0], [-2, 0]])) {
                const nr = r + dr, nc = c + dc;
                if (nr > 0 && nr < rows - 1 && nc > 0 && nc < cols - 1 && maze[nr][nc] === 1) {
                    maze[r + dr / 2][c + dc / 2] = 0;
                    generateMaze(nr, nc);
                }
            }
        }
        generateMaze(startRow, startCol); maze[startRow][startCol] = 0; maze[endRow][endCol] = 0;

        const doors = [], doorCount = 6;
        function getMathProblem() {
            let a = Math.floor(Math.random() * 10) + 1,
                b = Math.floor(Math.random() * 10) + 1;
            const add = Math.random() < 0.5;
            if (!add && b > a) [a, b] = [b, a];
            return { question: add ? `${a}+${b}` : `${a}-${b}`, answer: add ? a + b : a - b };
        }
        for (let i = 0; i < doorCount; i++) {
            let r, c;
            do {
                r = Math.floor(Math.random() * rows);
                c = Math.floor(Math.random() * cols);
            } while (maze[r][c] !== 0 || (r === startRow && c === startCol) || (r === endRow && c === endCol));
            const p = getMathProblem();
            doors.push({ row: r, col: c, locked: true, question: p.question, answer: p.answer });
        }

        let player1 = { row: startRow, col: startCol, color: "#fde047" };
        let player2 = { row: startRow, col: startCol, color: "#38bdf8" };
        let ai = { row: startRow, col: startCol, color: "#9d4edd" };
        let currentPlayer = 1, movesLeft = 0;
        const dice1 = document.getElementById("dice1"),
            dice2 = document.getElementById("dice2"),
            rollButton = document.getElementById("rollButton"),
            movesBox = document.getElementById("movesBox");

        function updateMovesDisplay() {
            movesBox.textContent = movesLeft > 0 ? movesLeft : "0";
        }

        function drawMaze() {
            frameCount++;
            const grassGrad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            grassGrad.addColorStop(0, "#7ED957");
            grassGrad.addColorStop(1, "#55B84D");
            ctx.fillStyle = grassGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const x = c * tileSize, y = r * tileSize;
                    if (maze[r][c] === 1) {
                        const hedgeGrad = ctx.createLinearGradient(x, y, x + tileSize, y + tileSize);
                        hedgeGrad.addColorStop(0, "#2F7D32");
                        hedgeGrad.addColorStop(0.5, "#1B5E20");
                        hedgeGrad.addColorStop(1, "#145214");
                        ctx.fillStyle = hedgeGrad;
                        ctx.fillRect(x, y, tileSize, tileSize);
                    } else {
                        const dirtGrad = ctx.createLinearGradient(x, y, x + tileSize, y + tileSize);
                        dirtGrad.addColorStop(0, "#A7E074");
                        dirtGrad.addColorStop(1, "#85C769");
                        ctx.fillStyle = dirtGrad;
                        ctx.fillRect(x, y, tileSize, tileSize);
                    }
                }
            }

            // start / end tiles
            ctx.fillStyle = "#4ade80";
            ctx.fillRect(startCol * tileSize, startRow * tileSize, tileSize, tileSize);
            ctx.fillStyle = "#0ea5e9";
            ctx.fillRect(endCol * tileSize, endRow * tileSize, tileSize, tileSize);

            // doors
            ctx.font = "bold 13px Comic Sans MS";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            for (const d of doors) {
                const x = d.col * tileSize, y = d.row * tileSize;
                ctx.fillStyle = d.locked ? "#9A3412" : "#22C55E";
                ctx.fillRect(x, y, tileSize, tileSize);
                ctx.strokeStyle = "#FFFFFF55";
                ctx.strokeRect(x, y, tileSize, tileSize);
                ctx.fillStyle = "white";
                ctx.fillText("Door", x + tileSize / 2, y + tileSize / 2);
            }

            
            const players = [player1, player2, ai];

            
            players.forEach((p, idx) => {
                if (idx + 1 !== currentPlayer) {
                    drawPlayer(p, false);
                }
            });

            
            const activePlayer = players[currentPlayer - 1];
            drawPlayer(activePlayer, true);
        }

        function drawPlayer(p, isActive) {
            const x = p.col * tileSize + tileSize / 2;
            const y = p.row * tileSize + tileSize / 2;

            ctx.save();
            ctx.translate(x, y);

            
            if (isActive) {
                ctx.scale(1.3, 1.3);   
            }

            const walk = Math.sin(frameCount / 5) * 3;

            // body
            ctx.fillStyle = p.color;
            ctx.fillRect(-3, -10, 6, 12);

            // head
            ctx.beginPath();
            ctx.arc(0, -15, 5, 0, Math.PI * 2);
            ctx.fillStyle = "#ffe5b4";
            ctx.fill();
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 1;
            ctx.stroke();

            // arms
            ctx.strokeStyle = p.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-5, -6);
            ctx.lineTo(-10, -6 + walk);
            ctx.moveTo(5, -6);
            ctx.lineTo(10, -6 - walk);
            ctx.stroke();

            // legs
            ctx.beginPath();
            ctx.moveTo(-3, 2);
            ctx.lineTo(-5, 8 - walk);
            ctx.moveTo(3, 2);
            ctx.lineTo(5, 8 + walk);
            ctx.stroke();

            ctx.restore();
        }



        function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

        function switchTurn() {
            // 1 → 2 → 3 → 1
            currentPlayer = currentPlayer === 1 ? 2 : (currentPlayer === 2 ? 3 : 1);

            const icons = ["🟡", "🔵", "🤖"];
            document.getElementById("turnText").textContent =
                `Turn: Player ${currentPlayer} ${icons[currentPlayer - 1]}`;

            movesLeft = 0;
            updateMovesDisplay();

           
            rollButton.disabled = (currentPlayer === 3);

            
            drawMaze();

           
            if (currentPlayer === 3) {
                runAITurn();
            }
        }


        async function runAITurn() {
            await sleep(700);
            rollButton.disabled = true;

            let count = 0;
            const interval = setInterval(() => {
                dice1.textContent = Math.floor(Math.random() * 6) + 1;
                dice2.textContent = Math.floor(Math.random() * 6) + 1;
                count++;
            }, 100);

            await sleep(1000);
            clearInterval(interval);
            const final1 = Math.floor(Math.random() * 6) + 1;
            const final2 = Math.floor(Math.random() * 6) + 1;
            dice1.textContent = final1;
            dice2.textContent = final2;
            const aiRoll = final1 + final2;
            movesLeft = aiRoll;
            updateMovesDisplay();

            await sleep(400);
            alert(`🤖 AI rolled ${final1} + ${final2} = ${aiRoll} moves!`);

            function findPath(startR, startC, endR, endC) {
                const queue = [[startR, startC]];
                const visited = Array(rows).fill().map(() => Array(cols).fill(false));
                const parent = {};
                visited[startR][startC] = true;

                const directions = [[1, 0], [-1, 0], [0, 1], [0, -1]];
                while (queue.length) {
                    const [r, c] = queue.shift();
                    if (r === endR && c === endC) break;

                    for (const [dr, dc] of directions) {
                        const nr = r + dr, nc = c + dc;
                        if (
                            nr >= 0 && nr < rows &&
                            nc >= 0 && nc < cols &&
                            maze[nr][nc] === 0 && !visited[nr][nc]
                        ) {
                            visited[nr][nc] = true;
                            parent[`${nr},${nc}`] = [r, c];
                            queue.push([nr, nc]);
                        }
                    }
                }

                const path = [];
                let cur = [endRow, endCol];
                while (cur && parent[`${cur[0]},${cur[1]}`]) {
                    path.unshift(cur);
                    cur = parent[`${cur[0]},${cur[1]}`];
                }
                return path;
            }

            const path = findPath(ai.row, ai.col, endRow, endCol);
            if (!path || path.length === 0) {
                alert("🤖 No path found!");
                switchTurn();
                return;
            }

            let step = 0;
            while (movesLeft > 0 && step < path.length) {
                const [nr, nc] = path[step];
                const door = doors.find(d => d.row === nr && d.col === nc);

                if (door && door.locked) {
                    const doorRoll = Math.floor(Math.random() * 6) + 1;
                    if (doorRoll % 2 === 0) {
                        alert(`🤖 Rolled ${doorRoll} (even) and passed the door!`);
                        door.locked = false;
                        ai.row = nr;
                        ai.col = nc;
                        movesLeft--;
                        updateMovesDisplay();
                        step++;
                    } else {
                        movesLeft--;
                        updateMovesDisplay();
                        alert(`🤖 Rolled ${doorRoll} (odd) and failed at the door. (${movesLeft} moves left)`);
                        drawMaze();
                        await sleep(400);
                        if (movesLeft <= 0) break;
                    }
                } else {
                    ai.row = nr;
                    ai.col = nc;
                    movesLeft--;
                    updateMovesDisplay();
                    step++;
                }

                drawMaze();
                await sleep(400);

                if (ai.row === endRow && ai.col === endCol) {
                    alert("🎉 AI reached the goal!");
                    window.location.href = "{% url 'options' %}";
                    return;
                }
            }

            alert("🤖 AI turn done!");
            switchTurn();
        }

        rollButton.addEventListener("click", () => {
            rollButton.disabled = true;
            const final1 = Math.floor(Math.random() * 6) + 1,
                final2 = Math.floor(Math.random() * 6) + 1;
            let count = 0;
            const interval = setInterval(() => {
                dice1.textContent = Math.floor(Math.random() * 6) + 1;
                dice2.textContent = Math.floor(Math.random() * 6) + 1;
                count++;
            }, 100);
            setTimeout(() => {
                clearInterval(interval);
                dice1.textContent = final1;
                dice2.textContent = final2;
                movesLeft = final1 + final2;
                updateMovesDisplay();
                setTimeout(() => alert(`🎲 You rolled ${final1}+${final2}=${movesLeft} moves!`), 200);
            }, 1000);
        });

        document.addEventListener("keydown", (e) => {
            if (movesLeft <= 0 || currentPlayer === 3) return;
            const p = currentPlayer === 1 ? player1 : player2;
            let nr = p.row, nc = p.col;
            if (e.key === "ArrowUp") nr--;
            else if (e.key === "ArrowDown") nr++;
            else if (e.key === "ArrowLeft") nc--;
            else if (e.key === "ArrowRight") nc++;
            if (nr >= 0 && nr < rows && nc >= 0 && nc < cols && maze[nr][nc] === 0) {
                const door = doors.find(d => d.row === nr && d.col === nc);
                if (door) {
                    const ans = prompt(`🌿 Solve to open the door: ${door.question}`);
                    if (ans !== null && parseInt(ans) === door.answer) {
                        alert("✅ Door unlocked!");
                        p.row = nr; p.col = nc;
                        const np = getMathProblem(); door.question = np.question; door.answer = np.answer;
                    } else {
                        movesLeft--;
                        updateMovesDisplay();
                        alert(`❌ Wrong! (${movesLeft} left)`);
                        const np = getMathProblem(); door.question = np.question; door.answer = np.answer;
                        if (movesLeft <= 0) { drawMaze(); setTimeout(() => switchTurn(), 200); return; }
                        drawMaze(); return;
                    }
                } else {
                    p.row = nr; p.col = nc;
                }
                movesLeft--;
                updateMovesDisplay();
                drawMaze();
                if (p.row === endRow && p.col === endCol) {
                    setTimeout(() => {
                        alert(`🎉 Player ${currentPlayer} won!`);
                        window.location.href = "{% url 'options' %}";
                    }, 200);
                    return;
                }
                if (movesLeft <= 0) {
                    setTimeout(() => { alert("🎯 No moves left! Next player's turn."); switchTurn(); }, 150);
                }
            }
        });

        drawMaze();
        updateMovesDisplay();
    </script>
</body>
</html>
